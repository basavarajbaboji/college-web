<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Meet our expert faculty members at Government Polytechnic College Hole Alur.">
    <title>Faculty | Government Polytechnic College Hole Alur</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <header>
        <div class="container" style="position: relative;">
            <h1>Government Polytechnic College Hole Alur</h1>
            <button class="menu-toggle" aria-label="Toggle navigation">‚ò∞</button>
            <nav>
                <ul class="nav-links" id="navLinks">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="branches.html">Branches</a></li>
                    <li><a href="admissions.html">Admissions</a></li>
                    <li><a href="faculty.html" aria-current="page">Faculty</a></li>
                    <li><a href="student_details.html">Student Details</a></li>
                    <li><a href="contact.html">Contact Us</a></li>
                    <li><a href="admin.html">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="section faculty-section">
            <div class="container">
                <h2 style="margin-bottom: 3rem;">üë®‚Äçüè´ Our Faculty</h2>

                <div id="facultyContainer">
                    <div style="text-align: center; padding: 3rem;">
                        <p>Loading faculty dimensions...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>¬© 2024 Government Polytechnic College Hole Alur. All rights reserved.</p>
        </div>
    </footer>

    <!-- Modal Structure -->
    <div id="facultyModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="script.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Faculty script loaded.");
            const container = document.getElementById('facultyContainer');

            // Global storage for faculty data to avoid HTML attribute quoting hell
            window.allFacultyData = [];

            function renderError(msg) {
                container.innerHTML = `<div style="text-align: center; color: red; padding: 2rem;">
                    <h3>‚ö†Ô∏è Error Loading Faculty</h3>
                    <p>${msg}</p>
                </div>`;
            }

            fetch('/api/faculty_details')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    const faculty = data.faculty || [];
                    if (faculty.length === 0) {
                        container.innerHTML = '<p style="text-align: center;">No faculty data available.</p>';
                        return;
                    }

                    // Store data globally for easy access by modal
                    window.allFacultyData = faculty;

                    console.log('Faculty Data loaded:', faculty.length);

                    // 1. Separate Principal (Safely)
                    const principal = faculty.find(f => f.role && f.role.toLowerCase().includes('principal'));
                    const others = faculty.filter(f => !f.role || !f.role.toLowerCase().includes('principal'));

                    // 2. Group others by Branch
                    const groups = {};
                    others.forEach(f => {
                        const branch = f.branch || 'Other Staff';
                        if (!groups[branch]) groups[branch] = [];
                        groups[branch].push(f);
                    });

                    // 3. Sorting logic
                    for (const branch in groups) {
                        groups[branch].sort((a, b) => {
                            const roleA = (a.role || '').toLowerCase();
                            const roleB = (b.role || '').toLowerCase();
                            const isAHod = roleA.includes('hod') || roleA.includes('head');
                            const isBHod = roleB.includes('hod') || roleB.includes('head');
                            if (isAHod && !isBHod) return -1;
                            if (!isAHod && isBHod) return 1;
                            return 0;
                        });
                    }

                    // Start Rendering
                    let html = '';

                    if (principal) {
                        // Find original index in the global array
                        const pIndex = faculty.indexOf(principal);
                        html += `
                            <div class="principal-container">
                                <div class="principal-card">
                                    ${createFacultyCard(principal, pIndex, 'principal')}
                                </div>
                            </div>
                        `;
                    }

                    const branchOrder = [
                        'Artificial Intelligence',
                        'Computer Science Engineering',
                        'Electrical and Electronics Engineering',
                        'Electronics and Communication Engineering',
                        'Non-Teaching',
                        'Other Staff'
                    ];

                    const existingBranches = Object.keys(groups);

                    branchOrder.forEach(branchName => {
                        if (groups[branchName] && groups[branchName].length > 0) {
                            html += renderBranchGroup(branchName, groups[branchName]);
                        }
                    });

                    existingBranches.forEach(branchName => {
                        if (!branchOrder.includes(branchName) && groups[branchName].length > 0) {
                            html += renderBranchGroup(branchName, groups[branchName]);
                        }
                    });

                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    renderError(err.message);
                });

            function renderBranchGroup(name, members) {
                const icon = name.includes('Artificial') ? 'üß†' :
                    name.includes('Computer') ? 'üíª' :
                        name.includes('Electrical') ? '‚ö°' :
                            name.includes('Electronics') ? 'üì°' : 'üë•';

                // Map members to their chunks to find original indices
                const cardsHtml = members.map(m => {
                    const idx = window.allFacultyData.indexOf(m);
                    return `<li>${createFacultyCard(m, idx)}</li>`;
                }).join('');

                return `
                    <div class="branch-group">
                        <div class="branch-header">${icon} ${name}</div>
                        <ul class="faculty-grid">
                            ${cardsHtml}
                        </ul>
                    </div>
                `;
            }



            function createFacultyCard(m, index, extraClass = '') {
                // No complex encoding! Just pass the index.
                return `
                    <div class="faculty-card ${extraClass}">
                        <div class="faculty-image-container">
                            <img src="${m.image_url || '/placeholder-avatar.png'}" onerror="this.src='https://via.placeholder.com/150?text=${encodeURIComponent(m.name)}'" alt="${m.name}">
                        </div>
                        <div class="faculty-info">
                            <h3 class="faculty-name">${m.name}</h3>
                            <div class="faculty-role">${m.role || 'Faculty'}</div>
                            <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 0.5rem;">${m.qualification || ''}</p>
                        </div>
                        
                        <button class="view-profile-btn" onclick="openModal(${index})">View Profile</button>
                    </div>
                `;
            }

            // Modal Functions
            window.openModal = function (index) {
                const m = window.allFacultyData[index];
                if (!m) return;

                const modal = document.getElementById('facultyModal');
                const body = document.getElementById('modalBody');

                body.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                         <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 1rem; border: 3px solid var(--gray-100);">
                            <img src="${m.image_url || '/placeholder-avatar.png'}" onerror="this.src='https://via.placeholder.com/150?text=${encodeURIComponent(m.name)}'" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <h2 style="color: var(--primary-blue); margin-bottom: 0.25rem;">${m.name}</h2>
                        <h4 style="color: var(--accent-purple); text-transform: uppercase; letter-spacing: 1px;">${m.role || ''}</h4>
                        <p style="color: var(--gray-600);">${m.qualification || ''}</p>
                    </div>

                    <div style="display: grid; gap: 1rem; border-top: 1px solid var(--gray-100); padding-top: 1.5rem;">
                         ${m.description ? `<p><strong>üìù About:</strong><br>${m.description}</p>` : ''}
                         <p><strong>üéØ Specialization:</strong> ${m.specialization || 'N/A'}</p>
                         <p><strong>üìö Subjects:</strong> ${m.subjects || 'N/A'}</p>
                         <p><strong>‚è≥ Experience:</strong> ${m.experience || 'N/A'}</p>
                         <p><strong>üèÜ Achievements:</strong> ${m.achievements || 'N/A'}</p>
                         <div style="display: flex; gap: 1.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-100);">
                            <span><strong>üìß Email:</strong> <a href="mailto:${m.email}">${m.email || 'N/A'}</a></span>
                            ${m.phone ? `<span><strong>üìû Phone:</strong> ${m.phone}</span>` : ''}
                         </div>
                    </div>
                `;

                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            window.closeModal = function () {
                const modal = document.getElementById('facultyModal');
                if (modal) modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Close on outside click
            document.getElementById('facultyModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });
        });
    </script>
</body>

</html>